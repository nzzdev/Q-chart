<!-- index.html to test what markup would look like locally (independent of target) -->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Q Renderer Skeleton</title>
    <meta name="description" content="">
    <link rel="stylesheet" href="https://service.sophie.nzz.ch/bundle/sophie-q@^1,sophie-font@^1,sophie-color@^1,sophie-viz-color@^1[general].css">
    <script src="https://rawgit.com/filamentgroup/loadCSS/master/src/loadCSS.js"></script> 
  </head>
  <body>
    <script src="node_modules/systemjs/dist/system.js"></script>    
    <div id="container">
      <div id="renderer"></div>
    </div>
    <script>
      let data = {
        "toolRuntimeConfig": {
          id: "1221asdasd",
          toolBaseUrl: 'http://localhost:3000'
        },
        "item": {
          "_id": "725bfea0cfe08fb2fb975d94f24e2abe",
          "_rev": "16-5bc831ebc5239b7293e8983e41aa6bde",
          "department": "Storytelling",
          "data": [
            [
              "Jahr",
              "Volumen",
              "asd"
            ],
            [
              "2003",
              "55",
              "45"
            ],
            [
              "2004",
              "88",
              "51"
            ],
            [
              "2005",
              "79",
              "87"
            ],
            [
              "2006",
              "101",
              "21"
            ],
            [
              "2007",
              "34",
              "46"
            ],
            [
              "2008",
              "44",
              "87"
            ],
            [
              "2009",
              "58",
              "39"
            ],
            [
              "2010",
              "55",
              "45"
            ],
            [
              "2011",
              "88",
              "51"
            ],
            [
              "2012",
              "79",
              "87"
            ],
            [
              "2013",
              "101",
              "21"
            ],
            [
              "2014",
              "34",
              "46"
            ],
            [
              "2015",
              "44",
              "87"
            ],
            [
              "2016",
              "58",
              "39"
            ]
          ],
          "sources": [],
          "options": {
            "chartType": "Bar",
            "barOptions": {
              "isBarChart": false,
              "forceBarsOnSmall": false
            },
            "dateSeriesOptions": {
              "interval": "year",
              "prognosisStart": 5
            },
            "lineChartOptions": {},
            "highlightDataSeries": 0
          },
          "title": "chart",
          "createdDate": "2017-05-29T10:33:20.067Z",
          "createdBy": "beni.buess@nzz.ch",
          "updatedDate": "2017-05-29T12:27:49.882Z",
          "updatedBy": "beni.buess@nzz.ch"
        }
      };

      function loadAllScripts(scripts, index, callback) {
        if (scripts[index] && scripts[index].url) {
          loadJS(scripts[index].url, () => {
            loadAllScripts(scripts, index + 1, callback)
          })
        } else {
          callback();
        }
      }

      fetch(`http://localhost:3000/rendering-info/html-js`, {
          method: 'POST',
          body: JSON.stringify(data),
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          return response.json();
        })
        .then(data => {
          data.stylesheets.forEach(stylesheet => {
            if (stylesheet.name) {
              stylesheet.url = `http://localhost:3000/stylesheet/${stylesheet.name}`
            }
            loadCSS(stylesheet.url)
          })
          document.getElementById('renderer').innerHTML = data.markup;

          data.scripts = data.scripts
            .map(script => {
              if (script.name) {
                script.url = `http://${window.location.hostname}:3000/script/${script.name}`
              }
              return script;
            })

          let urlScripts = data.scripts
            .filter(script => script.url)

          let contentScripts = data.scripts
            .filter(script => script.content)

          loadAllScripts(urlScripts, 0, () => {
            contentScripts.forEach(script => {
              let scriptElement = document.createElement('script');
              scriptElement.innerHTML = script.content;
              document.getElementById('container').appendChild(scriptElement);
            })
          })
        })
    </script>
  </body>
</html>
